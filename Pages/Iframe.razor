<!--
  Copyright (c) 2025 Ê∏üÈõ≤. All rights reserved.

  Licensed under the TOSSRCU 2025.9 License (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    https://raw.githubusercontent.com/M3351AN/M3351AN/9e7630a8511b8306c62952ca1a4f1ce0cc5b784a/LICENSE

  -----------------------------------------------------------------------------
  File: Iframe.razor
  Author: Ê∏üÈõ≤ (quq[at]outlook.it)
  Date: 2025-12-10

  -----------------------------------------------------------------------------
-->
@page "/iframe"
@using Microsoft.AspNetCore.Components.Forms
@using SPT.Fuyu.Patcher.Blazor.Services
@inject ExeAnalyzerService AnalyzerService
@inject JsInteropService JsInterop
@implements IDisposable
    <div class="content">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <h3 class="upload-text">@GetText("uploadText")</h3>
            <p>@GetText("fileSupport")</p>

            <InputFile OnChange="OnFileSelected"
                       accept=".exe"
                       class="file-input"
                       id="fileInput" />

            @if (_selectedFile != null)
            {
                <div class="file-info">
                    @GetText("fileSelected"): @_selectedFile.Name (@(_selectedFile.Size / 1024) KB)
                </div>
            }
        </div>

        @if (_isProcessing)
        {
            <div class="progress-container">
                <div class="progress">
                    <div class="progress-bar" style="width: @_progress%;">
                        @_progress%
                    </div>
                </div>
                <div class="progress-text">@_progressMessage</div>
            </div>
        }

        <button class="btn" @onclick="StartPatchProcess" disabled="@(_selectedFile == null || _isProcessing)">
            @GetText("patchButton")
        </button>

        @if (_showStatus)
        {
            <div class="status @_statusClass">
                @_statusMessage
            </div>
        }
    </div>

    <footer>
        <p>SPT Fuyu Patcher Web &copy; 2025 Ê∏üÈõ≤| <a href="https://github.com/M3351AN/SPT_Fuyu_Patcher_Web" target="_blank">GitHub</a></p>
    </footer>

<link href="css/app.css" rel="stylesheet" />
<style>
    body {
        background: transparent;
    }
</style>
@code {
    private IBrowserFile? _selectedFile;
    private bool _isProcessing = false;
    private bool _showStatus = false;
    private string _statusMessage = "";
    private string _statusClass = "";
    private int _progress = 0;
    private string _progressMessage = "";
    private string _currentLanguage = "zh";

    // Â§öËØ≠Ë®ÄÂ≠óÂÖ∏
    private Dictionary<string, Dictionary<string, string>> _messages = new()
    {
        ["zh"] = new()
        {
            ["uploadText"] = "ÈÄâÊã©ÊàñÊãñÊîæÂêØÂä®Âô®ÂèØÊâßË°åÊñá‰ª∂Âà∞Ê≠§Â§Ñ",
            ["fileSupport"] = "‰æãÂ¶Ç SPT.Launcher.exe",
            ["fileSelected"] = "Â∑≤ÈÄâÊã©Êñá‰ª∂",
            ["patchButton"] = "‰øÆË°•Êñá‰ª∂",
            ["selectFile"] = "ËØ∑ÈÄâÊã©Êñá‰ª∂",
            ["success"] = "‰øÆË°•ÊàêÂäü",
            ["unknownError"] = "Êú™Áü•ÈîôËØØ",
            ["notFound"] = "Êú™ÊâæÂà∞ÁõÆÊ†áÂ≠óËäÇÂ∫èÂàó",
            ["alreadyPatched"] = "Êñá‰ª∂Â∑≤Áªè‰øÆË°•Ëøá",
            ["notExe"] = "ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊúâÊïàÁöÑEXEÊñá‰ª∂"
        },
        ["en"] = new()
        {
            ["uploadText"] = "Select or drag & drop launcher executable file here",
            ["fileSupport"] = "i.e., SPT.Launcher.exe",
            ["fileSelected"] = "File selected",
            ["patchButton"] = "Patch File",
            ["selectFile"] = "Please select a file",
            ["success"] = "Patch successful",
            ["unknownError"] = "Unknown error",
            ["notFound"] = "Target byte sequence not found",
            ["alreadyPatched"] = "File already patched",
            ["notExe"] = "Please select a valid EXE file"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var browserLang = await JsInterop.GetLanguageAsync();
            if (browserLang?.StartsWith("zh", StringComparison.OrdinalIgnoreCase) == true)
            {
                _currentLanguage = "zh";
            }
            else
            {
                _currentLanguage = "en";
            }
        }
        catch
        {
            _currentLanguage = "zh";
        }
    }

    private string GetText(string key)
    {
        if (_messages.ContainsKey(_currentLanguage) && _messages[_currentLanguage].ContainsKey(key))
        {
            return _messages[_currentLanguage][key];
        }
        return key;
    }

    private void ToggleLanguage()
    {
        _currentLanguage = _currentLanguage == "zh" ? "en" : "zh";
        StateHasChanged();
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _showStatus = false;

        if (_selectedFile == null) return;

        if (_selectedFile.Size > 100 * 1024 * 1024)
        {
            await JsInterop.AlertAsync("File too large! Please select a file less than 100MB.");
            _selectedFile = null;
            return;
        }

        if (!_selectedFile.Name.EndsWith(".exe", StringComparison.OrdinalIgnoreCase))
        {
            await JsInterop.AlertAsync(GetText("notExe"));
            _selectedFile = null;
            return;
        }

        StateHasChanged();
    }

    private async Task StartPatchProcess()
    {
        if (_selectedFile == null) return;

        _isProcessing = true;
        _progress = 0;
        _showStatus = false;
        StateHasChanged();

        try
        {
            await UpdateProgress(10, _currentLanguage == "zh" ? "Ê≠£Âú®ËØªÂèñÊñá‰ª∂..." : "Reading file...");

            using var stream = _selectedFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);

            await UpdateProgress(30, _currentLanguage == "zh" ? "Ê≠£Âú®ÂàÜÊûêÊñá‰ª∂..." : "Analyzing file...");

            var result = await AnalyzerService.AnalyzeFileAsync(stream, _selectedFile.Name);

            if (!result.Success)
            {
                await ShowError(GetText("unknownError") + ": " + result.ErrorMessage);
                return;
            }

            if (result.AlreadyPatched)
            {
                await ShowError(GetText("alreadyPatched"));
                return;
            }

            if (result.PatchOffset < 0)
            {
                await ShowError(GetText("notFound"));
                return;
            }

            await UpdateProgress(70, _currentLanguage == "zh" ? "Ê≠£Âú®Â∫îÁî®‰øÆË°•..." : "Applying patch...");

            var modifiedData = await AnalyzerService.ApplyPatchAsync(result);

            await UpdateProgress(90, _currentLanguage == "zh" ? "Ê≠£Âú®ÂáÜÂ§á‰∏ãËΩΩ..." : "Preparing download...");

            var fileName = Path.GetFileNameWithoutExtension(result.FileName) + "_patched.exe";

            using var fileStream = new MemoryStream(modifiedData);
            using var streamRef = new DotNetStreamReference(fileStream);

            await JsInterop.InitiateDownloadAsync(fileName, streamRef);

            await UpdateProgress(100, _currentLanguage == "zh" ? "‰∏ãËΩΩÂ∑≤ÂºÄÂßãÔºÅ" : "Download started!");

            await ShowSuccess(GetText("success"));

            await Task.Delay(2000);

            ResetState();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during patching: {ex}");
            await ShowError(GetText("unknownError") + ": " + ex.Message);
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task UpdateProgress(int progress, string message)
    {
        _progress = progress;
        _progressMessage = message;
        StateHasChanged();
        await Task.Delay(100);
    }

    private async Task ShowSuccess(string message)
    {
        _statusMessage = message;
        _statusClass = "success";
        _showStatus = true;
        StateHasChanged();
    }

    private async Task ShowError(string message)
    {
        _statusMessage = message;
        _statusClass = "error";
        _showStatus = true;
        _isProcessing = false;
        StateHasChanged();
    }

    private void ResetState()
    {
        _isProcessing = false;
        _progress = 0;
        _showStatus = false;
        _selectedFile = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        _selectedFile = null;
    }
}
